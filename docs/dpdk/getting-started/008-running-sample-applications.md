
# 8. 运行示例应用程序

本章介绍了如何在 DPDK 环境中编译和运行应用程序，并指出了示例应用程序的存储位置。

## 8.1. 编译示例应用程序

有关编译示例程序的详细信息，请参考 [使用安装好的 DPDK 构建应用程序](https://www.google.com/search?q=https://doc.dpdk.org/guides/linux_gsg/build_dpdk.html%23building-applications-using-installed-dpdk)。

## 8.2. 运行示例应用程序

> **警告**
> 在运行应用程序之前，请确保：
> * 已完成大页（Hugepages）设置。
> * 已加载所使用的任何内核驱动程序。
> * 如有需要，应用程序使用的端口应绑定到相应的内核驱动程序。
> * 更多详情请参考 [Linux 驱动程序](https://doc.dpdk.org/guides/linux_gsg/linux_drivers.html)。
> 
> 

应用程序会链接到 DPDK 目标环境的配置环境抽象层（EAL）库，该库提供了一些适用于每个 DPDK 应用程序的通用选项。

您可以参考 [EAL 参数](https://doc.dpdk.org/guides/linux_gsg/linux_eal_parameters.html) 获取 EAL 选项列表。

将 DPDK 应用程序二进制文件拷贝到您的目标机器，然后按如下方式运行应用程序（假设存在核心 0-3 并用于运行该程序）：

```bash
./dpdk-helloworld -l 0-3

```

> **注意**
> `--proc-type` 和 `--file-prefix` EAL 选项用于运行多个 DPDK 进程。更多详情请参阅《DPDK 示例应用程序用户指南》中的“多进程示例应用程序”章节以及《DPDK 程序员指南》。

### 8.2.1. 应用程序对逻辑核心的使用

核心列表参数（`-l` / `--lcores`）通常用于为 DPDK 应用程序指定其运行的核心。由于这些逻辑核心编号及其在特定 NUMA 插槽（Socket）上的特定核心映射可能因平台而异，建议在选择每个案例中使用的核心列表时，考虑每个平台的核心布局。

当 DPDK 应用程序初始化 EAL 层时，会显示将要使用的逻辑核心及其插槽位置。通过检查 `/proc/cpuinfo` 文件（例如运行 `cat /proc/cpuinfo`），也可以确定系统中所有核心的信息。每个处理器列出的 `physical id` 属性指示其所属的 CPU 插槽。在使用其他处理器时，这对于理解逻辑核心到插槽的映射非常有用。

> **注意**
> 使用 Linux 工具 `lstopo` 可以获得更直观的逻辑核心布局图。在 Fedora 上，可以使用以下命令安装并运行：
> ```bash
> sudo yum install hwloc
> lstopo
> 
> ```
> 
> 
> 此命令会生成相当简短的文本输出：
> ```bash
> lstopo-no-graphics --merge
> 
> ```
> 
> 

> **警告**
> 逻辑核心布局在不同的单板布局之间可能会发生变化，在选择应用程序核心列表之前应进行检查。

### 8.2.2. 应用程序对大页内存的使用

运行应用程序时，建议使用与分配给大页内存量相同的内存。如果没有传递 `-m` 或 `--numa-mem` 参数，DPDK 应用程序在启动时会自动执行此操作。

如果通过显式传递 `-m` 或 `--numa-mem` 值请求了更多内存，应用程序将失败。然而，如果用户请求的内存少于保留的大页内存量，应用程序本身也可能失败，特别是使用 `-m` 选项时。原因如下：假设系统在插槽 0 中有 1024 个保留的 2 MB 页面，在插槽 1 中也有 1024 个。如果用户请求 128 MB 内存，这 64 个页面可能不符合约束：

* 大页内存可能仅由插槽 1 中的内核分配给应用程序。在这种情况下，如果应用程序尝试在插槽 0 中创建对象（如环形缓冲区或内存池），则会失败。为避免此问题，建议使用 `--numa-mem` 选项代替 `-m` 选项。
* 这些页面可以位于物理内存中的任何位置，虽然 DPDK EAL 会尝试在连续块中分配内存，但页面可能不连续。在这种情况下，应用程序将无法分配大的内存池。

`socket-mem` 选项可用于为特定插槽请求特定数量的内存。这通过提供 `--numa-mem` 标志并在每个插槽后跟请求的内存量来实现，例如，提供 `--numa-mem=0,512` 尝试仅为插槽 1 保留 512 MB。类似地，在四插槽系统上，要仅在插槽 0 和 2 上分别分配 1 GB 内存，可以使用参数 `--numa-mem=1024,0,1024`。对于任何未显式引用的 CPU 插槽（例如本例中的插槽 3），将不保留任何内存。如果 DPDK 无法在每个插槽上分配足够的内存，EAL 初始化将失败。

核心转储（Core dump）中是否包含大页由 `/proc/<pid>/coredump_filter` 控制。默认值为 33（十六进制），这意味着大页被排除在核心转储之外。此设置是按进程进行的并会被继承。详情请参考 `core(5)`。要在核心转储中包含已映射的大页，请在运行 DPDK 应用程序之前在父进程或 shell 中设置第 6 位（`0x40`）：

```bash
echo 0x73 > /proc/self/coredump_filter
./dpdk-application ...

```

> **注意**
> 在核心转储文件中包含大页会增加其大小，这可能会填满存储空间或使传输过载。大页通常保存应用程序处理的数据（如网络数据包），这些数据可能包含敏感信息。

## 8.3. 其他示例应用程序

DPDK 的 `examples` 目录中包含了其他示例应用程序。这些示例应用程序可以按照本手册前面章节所述的类似方式进行构建和运行。此外，请参阅 [《DPDK 示例应用程序用户指南》](https://doc.dpdk.org/guides/sample_app_ug/index.html) 以获取应用程序说明、具体的编译和执行说明以及对代码的一些解释。
